# EFS
EFSは、容量無制限で複数のEC2インスタンスから同時にアクセスが可能なファイルストレージサービスである。
クライアントからEFSへの接続は、一般的なNFSプロトコルをサポートしているため、NFSクライアントさえあれば特別なツールをインストールしたり
設定をしたりする必要はない。amazon-efs-utilsツールを使うと、EFSへのマウントに関する推奨オプションが含まれていたり、ファイルシステムにトラブルが
発生した場合のトラブルシューティングに役立つログが記録出来たりするため、EFSへ接続するクライアントには導入することをお勧めする！
# 重要ポイント
EFSは、容量無制限で複数のEC2インスタンスから同時にアクセスが可能なファイルストレージサービス。
システムに最適なモードを選択して使う必要がある。

# EFSの構成要素
EFSは次の３つの要素から構成されている。
・ファイルシステム
・マウントターゲット
・セキュリティグループ
EFSは、ファイルが作成されると自動的に３か所以上のAZに保存される分散ファイルシステムを構成する。
作成したファイルシステムにアクセスするために、AZごとにサブネットを指定してマウントターゲットを作成する。マウントターゲットを作成すると、
ターゲットポイント(接続FQDN)が１つと各AZのマウントターゲット用IPアドレスが発行される。EC2からは１つのFQDNでアクセスするが、内部的には
自動的に接続元のEC２インスタンスと同一AZのマウントターゲットIPアドレスが返却されるため、レイテンシーを低くするように設計されている。
また、マウントターゲットにはセキュリティグループを指定でき、EC2からEFSへの通信要件を定義して、不要なアクセスを制限できる。

# EFSのパフォーマンスモード
EFSには、汎用パフォーマンスモードと最大I/Oパフォーマンスモードの2つのパフォーマンスモードがある。
ほとんどの場合は、汎用パフォーマンスモードを使えば問題ない。ただし、数百～数千台といったクライアントから同時にEFSへアクセスがあるような
ユースケースにも耐えられるように、最大I/Oパフォーマンスモードが用意されている。最大I/Oパフォーマンスモードを選択した場合、スループットを
最大化する代わりに、各ファイル操作のレイテンシーが汎用パフォーマンスモードよりも少し高くなる。
どちらのモードを選択するのが良いかを見分ける指標として、CloudWatchのPercentlOLimitというメトリクスが参考になる。汎用パフォーマンスモードを
選択してシステムのユースケースに似たアクセスパターンで性能テストを実施し、PercentlOLimitがどのように遷移するかを確認する。性能テスト実施中に
PercentlOLimitが長時間高い状態(80～100％)である場合は、最大I/Oパフォーマンスモードに変更した方がいい場合がある。
パフォーマンスモードはファイルシステムを一度作成すると変更できないため、本番導入前に入念にテストを実施してどちらを利用するか検討すると良い。
# 重要ポイント
パフォーマンスモードは後から変更できないので、導入前によく検討しなければならない。CloudWatchのPercentlOLimitメトリクスが参考になる。

# EFSのスループットモード
EFSにはパフォーマンスモードとは別に２つのスループットモードが用意されている。「バーストスループットモード」と「プロビジョニングスループットモード」である。
・バーストスループットモード：このモードには、EFSに保存されているデータ容量に応じてベースラインとなるスループットが設計されている。一時的なスループットの
上昇にも耐えられるようなバースト機能を持ったモードである。ベースラインのスループットは1GBあたり50KB/秒で、保存されているデータ量に応じてスループットと期間が
設定されている。最低バーストスループットは100MB/秒である。1TBを超えると、毎日12時間、ストレージの1TBあたり100MB/秒までバーストできるバーストクレジットが貯まるように
設計されている。
・プロビジョニングスループットモード：バーストスループットモードで設定されているベースラインスループットを大幅に上回るスループットが必要な場合や、
一時的なバースト時にバーストスループットで定められている最大スループットよりも高い性能が必要な場合に、任意のスループット値を指定することができるモードである。
容量にによらず最大1GB/秒までのスループットを指定できる。それ以上のスループットが必要な場合は制限の緩和申請が可能である。このモードは、Web配信用のコンテンツや
アプリケーション用のデータといった、データサイズは、それほど大きくはないものの頻繁にアクセスしたり大量のインスタンスからの同時アクセスを受けるような
データをEFSに配置する場合に最適である。
どちらのスループットモードを選択すれば良いかを見分ける指標として、CloudWatchのBurstCreditBalanceというメトリクスが参考になる。
クレジットバランスを全て使い切ってしまったり、常に減少傾向である場合はプロビジョニングスループットモードを選択しよう。スループットモードは
EFS運用中にも変更できる。
プロビジョニングスループットで指定するスループット値は増減どちらも可能である。スループットモードの変更、及びプロビジョニングスループットモードでの
スループット値の削減は、前回の作業から24時間以上間隔をあける必要がある。
# 重要ポイント
スループットモードの選択には、CloudWatchのBurstCreditBalanceメトリクスが参考になる！
