# Amazon S3
S3は非常に優れた耐久性を持つ、容量無制限のオブジェクトストレージサービスである。
ファイルストレージとの違いとしては、ディレクトリ構造を持たないフラットな構成であることや、ユーザーが独自にデータに
対して情報(メタデータ)を付与できることが挙げられる。
S3の各オブジェクトには、RESTやSOAPといったHTTPをベースとしたWeb APIを使ってアクセスする。利用者がデータを保存するために利用するだけではなく、
EBSスナップショットの保存場所として使われるなど、AWSのバックエンドサービスにも使われていて、AWSの中でも非常に重要なサービスと位置付けられている。
主なユースケースは次の通りである。
・データバックアップ

・ビックデータ解析用などのデータレイク

・ETL(Extract/Transform/Load)の中間ファイル保存

・Auto Scaling構成されたEC2インスタンスやコンテナからのログ転送先

・静的コンテンツのホスティング

・簡易的なkey-Value型のデータサービス

# 重要ポイント
S3は、非常に優れた耐久性を持つ、容量無制限のオブジェクトストレージサービスで、様々な用途に利用できる。

# S3の構成要素
S3は、次の要素から構成されている。

・バケット：オブジェクトを保存するための領域である。バケット名はバケット名はアカウントやリージョンに関係なくAWS内で一位にする必要がある。

・オブジェクト：S3に格納されているデータそのものである。各オブジェクトにはキー(オブジェクト名)が付与され、「バケット名+キー名+バージョンID」
で必ず一意になるURLが作成される。このURLをWeb APIなどで指定してオブジェクトを操作する。バケット内に格納できるオブジェクト数に制限はないが、
１つのオブジェクトサイズは５TBまでである。

# S3の耐久性と整合性
S3に保存されたデータは、複数のAZ、さらにはAZ内の複数の物理的ストレージに複製される。これによって高い高い耐久性が維持される。
データの複製方式として、S3は結果整合性方式を採用している。そのため、データの保存後、複製が完全に終わるまでの間にデータを参照すると、参照先によっては
保存前の状態が表示されることもあるので注意が必要！

# ストレージクラス
S3には高い耐久性があるが、その中にも用途に応じて５つのランク(ストレージクラス)分けがされている。なお、次の各項の耐久性と可用性は設計上の性能で、
可用性にはSLAが設定されている。

#### STANDARD
デフォルトのストレージクラスである。低レイテンシーと高スループットを兼ね備えた、S3の性能が最も発揮されるクラスである。

・耐久性：99.999999999％(イレブンナイン)

・可用性：99.9％

#### STANDARD-IA
STANDARDに比べて格納コストが安価なストレージクラスである。参照頻度が低いデータ向けに設定されたクラスであるため、データへのアクセスは随時可能だが、
データの読み出し容量に対する従量課金が行われる。高速なアクセスが必要なものの、それほど頻繁にはアクセスしない、といったデータを保存するときに最適なクラスである。

・耐久性：99.999999999％(イレブンナイン)

・可用性：99.9％

#### ONEZONE-IA
単一のAZ内のみでデータを複製するストレージクラスである。高い耐久性を発揮するが、AZ単位で障害が発生した場合にデータの復元ができない可能性がある。
それ以外はSTANDARD-IAと同様のサービス仕様である。耐久性はイレブンナインだが、１つのAZ内の耐久性のため、保存しているAZでデータ消失を伴う障害が発生した場合、
データは失われる。

・耐久性：99.999999999％(イレブンナイン)

・可用性：99.5％

#### INTELLIGENT-TIERING
参照頻度の高低を明確に決めることができないデータを扱う場合に有効なストレージクラスである。STANDARDにとSTANDARD-IAの２層構成となっており、
３０日以上参照されなかったデータは自動的にSTANDARD-IAに移動される。

・耐久性：99.999999999％(イレブンナイン)

・可用性：99.9％

#### GLACIER
ほとんど参照されないアーカイブ目的のデータを保存するストレージクラスである。オブジェクト新規作成時にこのクラスを選択することはできない。
GLACIER以外のストレージクラスを選択して、後述するライフサイクル管理機能を使ってこのストレージクラスを指定することで利用可能になる。
GLACIERクラスに保存されたデータにアクセスする場合は、事前にアクセスをリクエストする必要があり、アクセスできるようになるまでには数時間かかる。
オブジェクトはGlacierに保存されるが、引き続きS3で管理するオブジェクトであり、Glacierを介して直接アクセスすることはできない。

・耐久性：99.999999999％(イレブンナイン)

・可用性：99.9％

# ライフサイクル管理
S3に保存されたオブジェクトはその利用頻度に応じてライフサイクルを定義することができる。
ライフサイクル設定では、次のどちらかを選択できる。
#### 移行アクション
データの利用頻度に応じてストレージクラスを変更するアクションである。例えば、オブジェクト作成当初はアクセス頻度が高いが、一定期間経過すると
利用頻度や重要度が低くなり、最後にはアーカイブとして保存しておく、といったライフサイクルに応じて最適なストレージクラスへ移行することができる。
#### 有効期限アクション
指定された期限を越えたオブジェクトをS3から削除するアクションである。利用期間が決まっているオブジェクトや一時的に作成されたオブジェクトなどを
定期的に整理することができる。S3は容量無制限のストレージサービスではあるが、保存容量に応じて従量課金されるため、不要なデータを定期的に削除
することでコスト削減が図れる。

# バージョニング機能
バージョニング機能を有効にすると、1つのオブジェクトに対して複数のバージョンを管理することができる。バージョニングはバケット単位で有効/無効を
指定できる。バージョニングされたオブジェクトは差分管理されるのではなく、新・旧オブジェクトの両方が保存され、バージョンIDで区別される。
両バージョン分の保存容量が必要になる。

# Webサイトホスティング機能
S3では、静的なコンテンツに限って、Webサイトとしてホスティングする環境を作成できる。静的コンテンツのリリースは通常のS3の利用と同様に、S3バケットへ
保存することで行える。

Ruby、Python、PHP、Perlなど、サーバーサイドの動的なコンテンツに関してはS3をWebサイトホスティングを行うには、EC2で独自にWebサーバーを作成するなどの
方法がある。

# 独自ドメインでS3Webサイトホスティングする場合の注意点
S3のWebサイトホスティングを設定すると自動的にドメイン(FQDN)が作成される。そのサイトに独自ドメインでアクセスしたい場合は、Route 53などのDNSに
CNAME情報を設定する。この際、バケット名とドメイン名を一致させる必要がある。www.example.com　でアクセスしたい場合は、バケット名もwww.example.com で
作成すること。S3の前段にCloudFrontを配置する場合は、バケット名とドメイン名を合わせる必要はない。

# S3のアクセス管理
S3のアクセス管理にはバケットポリシー、ACL、IAMが使える。
バケットポリシーはバケット単位でアクセスを制御する。そのバケットに保存されるオブジェクト全てに適用されるので、バケットの用途に応じた全体的なアクセス制御
をするときに有効である。ACL(アクセスコントロールリスト)はオブジェクト単位で公開/非公開を制御する場合に使用する。
バケットポリシーのIAMユーザー制御は、IAMユーザーの名称と一致したバケットのみを利用させるといった少し特殊なユースケースに適用可能な制御方法であるため、
IAMユーザーに対する制限を行う場合はIAMのポリシーを利用しよう。
# 重要ポイント
・S3のアクセス管理にはバケットポリシー、ACL、IAMを用いる。IAMユーザーに対する制限はバケットポリシーでも可能ではあるが、IAMのポリシーを使った方が良い。

# 署名付きURL
署名付きURLは、アクセス許可したいオブジェクトに対して期限を指定してURLを発行する機能である。バケットやオブジェクトのアクセス制御を変更することなく
特定のオブジェクトに一時的にアクセスを許可したい場合に非常に有効である。なお、この機能はユーザー制御ではないため、署名付きURLを知っていれば期間中は
誰でもアクセスできる。その点は注意が必要である。
# 重要ポイント
・署名付きURLは、特定のオブジェクトへのアクセス許可を一時的に与える。この期間中、URLを知っていれば当該オブジェクトには誰もがアクセスできる。この点は注意すべき。

# データ暗号化
S3に保存するデータは暗号化ができる。暗号化の方式は、サーバー側での暗号化とクライアント側での暗号化の２種類から選択できる。サーバー側での暗号化では、
テータがストレージに書き込まれるときに暗号化され、読みだされるときに復号化される。クライアント側での暗号化では、AWS SDKを使ってS3に送信する前にデータが
暗号化される。復号時は、クライアント側で暗号化されたデータのメタデータからどのキーで復号化するのかが判別され、それに基づいてオブジェクトが復号される。
